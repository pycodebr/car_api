# Estrutura do Projeto

## üìÅ Vis√£o Geral da Estrutura

```
car_api/
‚îú‚îÄ‚îÄ car_api/                    # üì¶ C√≥digo principal da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ app.py                  # üöÄ Arquivo principal do FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ core/                   # ‚öôÔ∏è Funcionalidades centrais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py         # üóÉÔ∏è Configura√ß√£o do banco de dados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.py         # üîê Fun√ß√µes de seguran√ßa e JWT
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py         # üìã Configura√ß√µes da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ models/                 # üèóÔ∏è Modelos SQLAlchemy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py             # üìÑ Classe base para modelos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cars.py             # üöó Modelos de carros e marcas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users.py            # üë§ Modelo de usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ routers/                # üõ£Ô∏è Rotas da API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py             # üîë Rotas de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ brands.py           # üè∑Ô∏è Rotas de marcas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cars.py             # üöó Rotas de carros
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users.py            # üë§ Rotas de usu√°rios
‚îÇ   ‚îî‚îÄ‚îÄ schemas/                # üìù Esquemas Pydantic
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ auth.py             # üîë Esquemas de autentica√ß√£o
‚îÇ       ‚îú‚îÄ‚îÄ brands.py           # üè∑Ô∏è Esquemas de marcas
‚îÇ       ‚îú‚îÄ‚îÄ cars.py             # üöó Esquemas de carros
‚îÇ       ‚îî‚îÄ‚îÄ users.py            # üë§ Esquemas de usu√°rios
‚îú‚îÄ‚îÄ docs/                       # üìö Documenta√ß√£o do projeto
‚îÇ   ‚îú‚îÄ‚îÄ index.md                # üè† P√°gina inicial da documenta√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ overview.md             # üìñ Vis√£o geral
‚îÇ   ‚îú‚îÄ‚îÄ prerequisites.md        # üîß Pr√©-requisitos
‚îÇ   ‚îú‚îÄ‚îÄ installation.md         # üíø Instala√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ configuration.md        # ‚öôÔ∏è Configura√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ guidelines.md           # üìè Guidelines e padr√µes
‚îÇ   ‚îú‚îÄ‚îÄ structure.md            # üìÅ Este arquivo
‚îÇ   ‚îî‚îÄ‚îÄ ...                     # üìÑ Outros arquivos de documenta√ß√£o
‚îú‚îÄ‚îÄ migrations/                 # üîÑ Migra√ß√µes do Alembic
‚îÇ   ‚îú‚îÄ‚îÄ env.py                  # üåç Configura√ß√£o do ambiente Alembic
‚îÇ   ‚îî‚îÄ‚îÄ versions/               # üìÖ Vers√µes das migra√ß√µes
‚îÇ       ‚îî‚îÄ‚îÄ *.py                # üìÑ Arquivos de migra√ß√£o
‚îú‚îÄ‚îÄ tests/                      # üß™ Testes automatizados
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py             # ‚öôÔ∏è Configura√ß√µes dos testes
‚îÇ   ‚îú‚îÄ‚îÄ test_auth.py            # üîë Testes de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ test_brands.py          # üè∑Ô∏è Testes de marcas
‚îÇ   ‚îú‚îÄ‚îÄ test_cars.py            # üöó Testes de carros
‚îÇ   ‚îú‚îÄ‚îÄ test_db.py              # üóÉÔ∏è Testes de banco de dados
‚îÇ   ‚îî‚îÄ‚îÄ test_users.py           # üë§ Testes de usu√°rios
‚îú‚îÄ‚îÄ .env                        # üîê Vari√°veis de ambiente (local)
‚îú‚îÄ‚îÄ .env.example                # üìã Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ alembic.ini                 # ‚öôÔ∏è Configura√ß√£o do Alembic
‚îú‚îÄ‚îÄ docker-compose.yml          # üê≥ Configura√ß√£o Docker Compose
‚îú‚îÄ‚îÄ Dockerfile                  # üê≥ Imagem Docker da aplica√ß√£o
‚îú‚îÄ‚îÄ Dockerfile.mkdocs           # üìö Imagem Docker para documenta√ß√£o
‚îú‚îÄ‚îÄ poetry.lock                 # üîí Lock file do Poetry
‚îú‚îÄ‚îÄ pyproject.toml              # üì¶ Configura√ß√£o do projeto
‚îú‚îÄ‚îÄ README.md                   # üìñ Documenta√ß√£o b√°sica
‚îî‚îÄ‚îÄ requirements.txt            # üìã Depend√™ncias (gerado pelo Poetry)
```

## üì¶ Detalhamento dos Diret√≥rios

### üöÄ `car_api/app.py` - Aplica√ß√£o Principal

Arquivo de entrada da aplica√ß√£o FastAPI:

```python
from fastapi import FastAPI
from car_api.routers import auth, brands, cars, users

app = FastAPI()

# Configura√ß√£o de routers
app.include_router(auth.router, prefix='/api/v1/auth', tags=['authentication'])
app.include_router(users.router, prefix='/api/v1/users', tags=['users'])
app.include_router(brands.router, prefix='/api/v1/brands', tags=['brands'])
app.include_router(cars.router, prefix='/api/v1/cars', tags=['cars'])

# Health check endpoint
@app.get('/health_check')
def health_check():
    return {'status': 'ok'}
```

**Responsabilidades:**
- Criar inst√¢ncia do FastAPI
- Registrar routers e middleware
- Configurar CORS e outros middleware
- Definir endpoints globais

### ‚öôÔ∏è `car_api/core/` - Funcionalidades Centrais

#### `database.py` - Configura√ß√£o do Banco

```python
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker

engine = create_async_engine(settings.database_url)
SessionLocal = async_sessionmaker(engine, expire_on_commit=False)

async def get_session():
    async with SessionLocal() as session:
        yield session
```

**Responsabilidades:**
- Configurar engine do SQLAlchemy
- Gerenciar sess√µes de banco
- Dependency injection para sess√µes

#### `security.py` - Seguran√ßa e Autentica√ß√£o

```python
from pwdlib import PasswordHash
import jwt

pwd_context = PasswordHash.recommended()

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)

def create_access_token(data: dict) -> str:
    return jwt.encode(data, settings.jwt_secret_key, algorithm=settings.jwt_algorithm)
```

**Responsabilidades:**
- Hash de senhas com Argon2
- Cria√ß√£o e valida√ß√£o de tokens JWT
- Dependency para usu√°rio atual
- Verifica√ß√£o de permiss√µes

#### `settings.py` - Configura√ß√µes

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str = 'sqlite+aiosqlite:///./car.db'
    jwt_secret_key: str
    jwt_algorithm: str = 'HS256'
    jwt_expiration_minutes: int = 30

    class Config:
        env_file = '.env'
```

**Responsabilidades:**
- Centralizar configura√ß√µes
- Valida√ß√£o de vari√°veis de ambiente
- Type hints para configura√ß√µes

### üèóÔ∏è `car_api/models/` - Modelos de Dados

#### `base.py` - Classe Base

```python
from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
```

#### `users.py` - Modelo de Usu√°rios

```python
class User(Base):
    __tablename__ = 'users'

    id: Mapped[int] = mapped_column(primary_key=True)
    username: Mapped[str] = mapped_column(unique=True)
    email: Mapped[str] = mapped_column(unique=True)
    password: Mapped[str]
    created_at: Mapped[datetime] = mapped_column(server_default=func.now())
    updated_at: Mapped[datetime] = mapped_column(onupdate=func.now())

    cars: Mapped[list['Car']] = relationship(back_populates='owner')
```

#### `cars.py` - Modelos de Carros e Marcas

```python
class Brand(Base):
    __tablename__ = 'brands'

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(50), unique=True)
    description: Mapped[Optional[str]] = mapped_column(Text)
    is_active: Mapped[bool] = mapped_column(default=True)

class Car(Base):
    __tablename__ = 'cars'

    id: Mapped[int] = mapped_column(primary_key=True)
    model: Mapped[str] = mapped_column(String(100))
    factory_year: Mapped[int]
    model_year: Mapped[int]
    color: Mapped[str] = mapped_column(String(30))
    plate: Mapped[str] = mapped_column(String(10), unique=True)
    fuel_type: Mapped[FuelType]
    transmission: Mapped[TransmissionType]
    price: Mapped[Decimal] = mapped_column(Numeric(10, 2))

    # Relacionamentos
    brand_id: Mapped[int] = mapped_column(ForeignKey('brands.id'))
    owner_id: Mapped[int] = mapped_column(ForeignKey('users.id'))

    brand: Mapped['Brand'] = relationship('Brand', back_populates='cars')
    owner: Mapped['User'] = relationship('User', back_populates='cars')
```

**Caracter√≠sticas dos Modelos:**
- **Type hints completos** com `Mapped[]`
- **Relacionamentos bidirecionais**
- **Campos de auditoria** (created_at, updated_at)
- **Valida√ß√µes de integridade**
- **Enums** para campos categ√≥ricos

### üõ£Ô∏è `car_api/routers/` - Rotas da API

Cada router implementa as opera√ß√µes CRUD para sua entidade:

#### Estrutura Padr√£o de Router

```python
from fastapi import APIRouter, Depends, HTTPException, Query, status
from sqlalchemy.ext.asyncio import AsyncSession

router = APIRouter()

@router.post('/', status_code=status.HTTP_201_CREATED, response_model=Schema)
async def create_item(): pass

@router.get('/', status_code=status.HTTP_200_OK, response_model=ListSchema)
async def list_items(): pass

@router.get('/{item_id}', status_code=status.HTTP_200_OK, response_model=Schema)
async def get_item(): pass

@router.put('/{item_id}', status_code=status.HTTP_200_OK, response_model=Schema)
async def update_item(): pass

@router.delete('/{item_id}', status_code=status.HTTP_204_NO_CONTENT)
async def delete_item(): pass
```

#### Funcionalidades Implementadas

**`auth.py`:**
- `POST /token` - Gerar token de acesso
- `POST /refresh_token` - Renovar token

**`users.py`:**
- CRUD completo de usu√°rios
- Busca por username/email
- Valida√ß√£o de unicidade

**`brands.py`:**
- CRUD completo de marcas
- Filtros por status ativo
- Prote√ß√£o contra dele√ß√£o com carros

**`cars.py`:**
- CRUD completo de carros
- Filtros avan√ßados (pre√ßo, combust√≠vel, etc.)
- Verifica√ß√£o de propriedade
- Busca por modelo/placa

### üìù `car_api/schemas/` - Esquemas Pydantic

#### Padr√£o de Nomenclatura

```python
# Schema para cria√ß√£o (entrada)
class UserSchema(BaseModel):
    username: str
    email: str
    password: str

# Schema para atualiza√ß√£o (entrada parcial)
class UserUpdateSchema(BaseModel):
    username: Optional[str] = None
    email: Optional[str] = None
    password: Optional[str] = None

# Schema p√∫blico (sa√≠da - sem senha)
class UserPublicSchema(BaseModel):
    id: int
    username: str
    email: str
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True

# Schema para listagem
class UserListPublicSchema(BaseModel):
    users: list[UserPublicSchema]
    offset: int
    limit: int
```

#### Funcionalidades dos Schemas

**Valida√ß√£o de Entrada:**
```python
class CarSchema(BaseModel):
    model: str = Field(..., min_length=1, max_length=100)
    factory_year: int = Field(..., ge=1900, le=2030)
    price: Decimal = Field(..., gt=0)
    plate: str = Field(..., regex=r'^[A-Z]{3}[0-9]{4}$|^[A-Z]{3}[0-9][A-Z][0-9]{2}$')
```

**Configura√ß√£o para SQLAlchemy:**
```python
class Config:
    from_attributes = True  # Permite convers√£o de modelos SQLAlchemy
```

### üîÑ `migrations/` - Migra√ß√µes do Banco

#### Estrutura das Migra√ß√µes

```
migrations/
‚îú‚îÄ‚îÄ env.py                      # Configura√ß√£o do Alembic
‚îî‚îÄ‚îÄ versions/
    ‚îî‚îÄ‚îÄ 20231201_120000_create_tables.py
```

#### Exemplo de Migra√ß√£o

```python
"""create tables

Revision ID: d519a757c476
Revises:
Create Date: 2023-12-01 12:00:00.000000
"""

from alembic import op
import sqlalchemy as sa

revision = 'd519a757c476'
down_revision = None
branch_labels = None
depends_on = None

def upgrade() -> None:
    # Criar tabelas
    op.create_table('users', ...)
    op.create_table('brands', ...)
    op.create_table('cars', ...)

def downgrade() -> None:
    # Reverter tabelas
    op.drop_table('cars')
    op.drop_table('brands')
    op.drop_table('users')
```

### üß™ `tests/` - Testes Automatizados

#### Estrutura dos Testes

```
tests/
‚îú‚îÄ‚îÄ conftest.py                 # Fixtures compartilhadas
‚îú‚îÄ‚îÄ test_auth.py               # Testes de autentica√ß√£o
‚îú‚îÄ‚îÄ test_brands.py             # Testes de marcas
‚îú‚îÄ‚îÄ test_cars.py               # Testes de carros
‚îú‚îÄ‚îÄ test_db.py                 # Testes de banco
‚îî‚îÄ‚îÄ test_users.py              # Testes de usu√°rios
```

#### Fixtures Principais (`conftest.py`)

```python
@pytest_asyncio.fixture
async def db_session():
    # Sess√£o de banco para testes

@pytest_asyncio.fixture
async def client(db_session):
    # Cliente HTTP para testes

@pytest_asyncio.fixture
async def sample_user(db_session):
    # Usu√°rio de exemplo para testes

@pytest_asyncio.fixture
async def auth_headers(sample_user):
    # Headers de autentica√ß√£o
```

#### Padr√£o de Testes

```python
class TestCarEndpoints:
    async def test_create_car_success(self, client, auth_headers):
        # Teste de cria√ß√£o bem-sucedida

    async def test_create_car_invalid_data(self, client, auth_headers):
        # Teste com dados inv√°lidos

    async def test_get_car_not_found(self, client, auth_headers):
        # Teste de recurso n√£o encontrado
```

## üîß Arquivos de Configura√ß√£o

### `pyproject.toml` - Configura√ß√£o Principal

```toml
[project]
name = "car-api"
version = "0.1.0"
description = "API para gerenciamento de carros"

[tool.ruff]
line-length = 79
select = ['I', 'F', 'E', 'W', 'PL', 'PT']

[tool.taskipy.tasks]
lint = 'ruff check'
format = 'ruff format'
test = 'pytest -v --cov=car_api'
run = 'fastapi dev car_api/app.py'
```

### `alembic.ini` - Configura√ß√£o de Migra√ß√µes

```ini
[alembic]
script_location = migrations
file_template = %%(year)d%%(month).2d%%(day).2d_%%(hour).2d%%(minute).2d_%%(rev)s_%%(slug)s

sqlalchemy.url =
```

### `docker-compose.yml` - Orquestra√ß√£o

```yaml
version: '3.8'
services:
  api:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql+psycopg://postgres:postgres@db:5432/car_api

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: car_api
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

## üìä M√©tricas da Estrutura

### Tamanho dos M√≥dulos

| M√≥dulo | Arquivos | Linhas de C√≥digo | Responsabilidade |
|--------|----------|------------------|------------------|
| `core/` | 3 | ~200 | Infraestrutura |
| `models/` | 3 | ~150 | Modelo de dados |
| `routers/` | 4 | ~800 | API endpoints |
| `schemas/` | 4 | ~300 | Valida√ß√£o |
| `tests/` | 6 | ~600 | Testes |

### Complexidade

- **M√≥dulos independentes**: Baixo acoplamento
- **Responsabilidades claras**: Alta coes√£o
- **Facilidade de teste**: Dependency injection
- **Escalabilidade**: F√°cil adicionar novos m√≥dulos

## üéØ Princ√≠pios Arquiteturais

### Single Responsibility Principle (SRP)
Cada m√≥dulo tem uma responsabilidade espec√≠fica:
- `routers/`: Apenas endpoints HTTP
- `models/`: Apenas estrutura de dados
- `schemas/`: Apenas valida√ß√£o
- `core/`: Apenas infraestrutura

### Dependency Inversion Principle (DIP)
```python
# ‚úÖ Depende de abstra√ß√£o (AsyncSession)
async def create_car(db: AsyncSession):
    pass

# ‚ùå Dependeria de implementa√ß√£o concreta
async def create_car(postgres_connection):
    pass
```

### Open/Closed Principle (OCP)
- F√°cil adicionar novos endpoints sem modificar existentes
- F√°cil adicionar novos modelos sem afetar outros
- Middleware pode ser adicionado sem modificar routers

### Interface Segregation Principle (ISP)
- Schemas espec√≠ficos para cada opera√ß√£o
- Dependencies injetadas apenas quando necess√°rias
- Interfaces pequenas e focadas

## üöÄ Escalabilidade

### Horizontal (Adicionar Funcionalidades)

1. **Novo Modelo de Dados:**
   ```
   car_api/models/categories.py      # Novo modelo
   car_api/schemas/categories.py     # Novos schemas
   car_api/routers/categories.py     # Novos endpoints
   tests/test_categories.py          # Novos testes
   ```

2. **Nova Funcionalidade:**
   ```
   car_api/core/notifications.py    # Nova infraestrutura
   car_api/services/email.py        # Nova service layer
   ```

### Vertical (Melhorar Existente)

1. **Otimiza√ß√£o de Performance:**
   - Cache em `core/cache.py`
   - Rate limiting em `core/middleware.py`

2. **Melhor Observabilidade:**
   - Logging em `core/logging.py`
   - M√©tricas em `core/metrics.py`

## üìö Pr√≥ximos Passos

Para entender melhor a estrutura:

1. üìñ Leia os [Guidelines e Padr√µes](guidelines.md)
2. üõ†Ô∏è Explore os [API Endpoints](api-endpoints.md)
3. üèóÔ∏è Entenda a [Modelagem do Sistema](system-modeling.md)
4. üíª Comece o [Desenvolvimento](development.md)